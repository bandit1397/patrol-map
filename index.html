100% 그대로 유지한 통합 HTML입니다.

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>출동/순찰 시스템 (Leaflet 마커 클릭 색상 + 지도 클릭 좌표)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
#map { height: 100%; width: 100%; }
#panel { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: #fff; padding: 10px; border-radius: 5px; max-width: 400px; width: 90%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
#panel input, #panel button { width: 100%; margin: 5px 0; padding: 8px; font-size: 14px; border-radius: 4px; border: 1px solid #007bff; }
#panel button { cursor: pointer; color: #fff; background: #007bff; border: none; }
#clickedCoords { background:#eef6ff; border:1px solid #007bff; text-align:center; padding:6px; border-radius:4px; font-size:13px; }
#upcomingPanel { position: fixed; top: 10px; right: 10px; width: 250px; max-height: 60vh; overflow-y:auto; background: rgba(255,255,255,0.95); border:1px solid #007bff; border-radius:5px; padding:10px; font-size:14px; z-index:1000; box-shadow:2px 2px 5px rgba(0,0,0,0.2); cursor:pointer; }
#upcomingPanel h4 { margin:0 0 5px; color:#007bff; font-size:16px; }
#upcomingList { list-style:none; margin:0; padding:0; }
#upcomingList li { padding:5px 8px; border-bottom:1px solid #ddd; cursor:pointer; border-radius:3px; user-select:none; }
#upcomingList li:hover { background:#eef6ff; }
#upcomingPanel.hidden { width:50px; height:40px; padding:5px; overflow:hidden; cursor:pointer; }
#upcomingPanel.hidden h4, #upcomingPanel.hidden ul { display:none; }
#upcomingPanel.hidden::after { content:"⏰"; position:absolute; top:10px; left:15px; font-size:20px; color:#007bff; }
</style>
</head>
<body>

<div id="panel">
  <label>순찰카테고리:</label>
  <ul id="categoryList" style="display:flex; gap:10px; justify-content:center; padding:0; margin:5px 0; list-style:none;">
    <li data-cat="안전조치" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">안전조치</li>
    <li data-cat="?" style="padding:5px 12px; border:1px solid #007bff; border-radius:5px; cursor:pointer; background:#007bff; color:white;">?</li>
  </ul>
  <input type="text" id="keyword" placeholder="키워드 입력 (예: 안양천 9-2, 공중전화, 안전조치 등)">
  <div style="display:flex; gap:5px;">
    <button onclick="searchAndShow()" style="flex:1;">검색</button>
    <button onclick="resetSearch()" style="flex:1; background:#6c757d;">초기화</button>
  </div>
  <div id="clickedCoords">📍</div>
  <div style="display:flex; gap:5px; margin-top:5px;">
    <button onclick="completePatrol()" style="flex:1; background:#28a745;">✅ 순찰 완료</button>
    <button onclick="navigateToPatrol()" style="flex:1;">📍 길찾기</button>
    <button onclick="shareKakaoLink()" style="flex:1; background:#ff9900;">💬 카톡 공유</button>
  </div>
</div>

<div id="upcomingPanel">
  <h4>⏰ 순찰 후 순찰완료 요망</h4>
  <ul id="upcomingList"></ul>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="lampData.js"></script>
<script src="patrolSchedule.js"></script>
<script>
let map = L.map('map').setView([37.3857, 126.6586], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = L.markerClusterGroup();
let searchMode = false;
let lastClickedCoord = "";
let activeCategories = ["안전조치"];
let activePatrol = null;
let completedPatrols = new Set(JSON.parse(localStorage.getItem("patrol_" + new Date().toISOString().slice(0,10)) || "[]"));
let selectedMarker = null; // 클릭된 마커 저장
let clickMarker = null; // 지도 클릭으로 생성되는 마커 저장

function parseCoords(s){ const [lat,lng]=s.split(",").map(Number); return [lat,lng]; }
function pad(n){ return n.toString().padStart(2,"0"); }

function addMarker(id, pos, color="blue") {
  const icon = L.icon({
    iconUrl:`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
    iconSize:[32,32],
    iconAnchor:[16,32]
  });

  const m = L.marker(pos, {title:id, icon: icon});

  m.on('click', ()=> {
    const data = lampData[id];
    lastClickedCoord = data.좌표;
    document.getElementById("clickedCoords").innerText = `📍 선택: ${lastClickedCoord}`;

    if(selectedMarker) {
      selectedMarker.setIcon(L.icon({
        iconUrl:`http://maps.google.com/mapfiles/ms/icons/blue-dot.png`,
        iconSize:[32,32],
        iconAnchor:[16,32]
      }));
    }
    m.setIcon(L.icon({
      iconUrl:`http://maps.google.com/mapfiles/ms/icons/red-dot.png`,
      iconSize:[32,32],
      iconAnchor:[16,32]
    }));
    selectedMarker = m;

    const popupContent = `
      <div style="min-width:150px;">
        <strong>분류:</strong> ${data.분류 || ""}<br/>
        <strong>고유이름:</strong> ${data.고유이름 || ""}<br/>
        <strong>전화번호:</strong> ${data.전화번호 || ""}<br/>
        <strong>주소:</strong> ${data.주소 || ""}<br/>
        <strong>특이사항:</strong> ${data.특이사항 || ""}<br/>
        <strong>좌표:</strong> ${data.좌표 || ""}
      </div>
    `;
    m.bindPopup(popupContent).openPopup();
  });

  markers.addLayer(m);
}

function clearMarkers(){ markers.clearLayers(); selectedMarker=null; }

function searchAndShow() {
  const kw=document.getElementById("keyword").value.trim();
  if(!kw){ alert("⚠️ 키워드 입력"); return; }
  searchMode=true;
  clearMarkers();
  const normalize = s=> (s||"").toLowerCase().replace(/[\s\-\_\.,\/\(\)\[\]#]/g,"");
  const kwNorm = normalize(kw);
  if(kwNorm.length<2){ alert("⚠️ 최소 2글자 이상"); return; }
  const regex=new RegExp(kwNorm.split("").join(".*"),"i");

  const res=Object.keys(lampData).filter(id=>{
    const d=lampData[id];
    const fields=[d.고유이름,d.전화번호,d.주소,d.분류,d.특이사항];
    return fields.some(f=>{
      const fn=normalize(f);
      return regex.test(fn)||fn.includes(kwNorm);
    });
  }).map(id=>({id,pos:parseCoords(lampData[id].좌표)}));

  if(res.length===0){ alert("❌ 검색 결과 없음"); return; }

  res.forEach(r=>addMarker(r.id,r.pos));
  map.addLayer(markers);
  const group = L.featureGroup(res.map(r=>L.marker(r.pos)));
  map.fitBounds(group.getBounds().pad(0.2));
}

function resetSearch(){ 
  searchMode=false; 
  clearMarkers(); 
  document.getElementById("keyword").value=""; 
  lastClickedCoord=""; 
  document.getElementById("clickedCoords").innerText="📍"; 
  map.setView([37.3857,126.6586],15); 
}

// 지도 클릭 시 좌표 표시
map.on('click', function(e){
  const lat = e.latlng.lat.toFixed(6);
  const lng = e.latlng.lng.toFixed(6);
  lastClickedCoord = `${lat},${lng}`;
  document.getElementById("clickedCoords").innerText = `📍 선택: ${lastClickedCoord}`;

  // 기존 클릭 마커 제거
  if(clickMarker) map.removeLayer(clickMarker);

  // 새로운 마커 추가
  clickMarker = L.marker([lat,lng], {
    icon: L.icon({
      iconUrl: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
      iconSize: [32,32],
      iconAnchor: [16,32]
    })
  }).addTo(map);
});

function navigateToPatrol(){
  if(!lastClickedCoord){ alert("⚠️ 먼저 좌표 선택"); return; }
  const [lat,lng]=lastClickedCoord.split(",");
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const startLat=pos.coords.latitude.toFixed(6), startLng=pos.coords.longitude.toFixed(6);
      const appUrl=`kakaomap://route?sp=${startLat},${startLng}&ep=${lat},${lng}&by=CAR`;
      const webUrl=`https://map.kakao.com/link/to/선택위치,${lat},${lng}`;
      if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
        window.location.href=appUrl;
        setTimeout(()=>window.open(webUrl,"_blank"),1500);
      } else { window.open(webUrl,"_blank"); }
    }, ()=>window.open(`https://map.kakao.com/link/to/선택위치,${lat},${lng}`,"_blank"));
  } else { window.open(`https://map.kakao.com/link/to/선택위치,${lat},${lng}`,"_blank"); }
}

function shareKakaoLink(){
  if(!lastClickedCoord){ alert("⚠️ 먼저 좌표 선택"); return; }
  const [lat,lng] = lastClickedCoord.split(",");
  const url = `https://map.kakao.com/link/map/선택위치,${lat},${lng}`;

  if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
    window.open(`kakaotalk://send?text=${encodeURIComponent(url)}`, "_blank");
  } else {
    // URL 자동 복사
    navigator.clipboard.writeText(url).then(() => {
      alert("✅ URL이 복사되었습니다!");  // 이전 prompt 대신 복사 알림
    }).catch(() => {
      prompt("복사 실패! 수동 복사하세요:", url);
    });
  }
}

function completePatrol(){
  if(!activePatrol){ alert("🚫 진행 중인 순찰 없음"); return; }
  completedPatrols.add(activePatrol.key);
  localStorage.setItem("patrol_" + new Date().toISOString().slice(0,10), JSON.stringify([...completedPatrols]));
  const patrolId=activePatrol.task.id;
  const data=lampData[patrolId];
  const patrolTime=new Date().toLocaleString("ko-KR");
  const logLine=`아이디:${patrolId}, 순찰시간:${patrolTime}, 고유이름:${data?.고유이름||"정보없음"}, 주소:${data?.주소||"주소없음"}\n`;
  const todayKey="patrol_text_log_" + new Date().toISOString().slice(0,10);
  const existing=localStorage.getItem(todayKey)||"";
  localStorage.setItem(todayKey, existing+logLine);
  alert(`✅ ${patrolId} (${activePatrol.key.split("|")[1]}) 순찰 완료!`);
  activePatrol=null;
  showUpcomingPatrols();
}

function getActivePatrolSchedule(){
  let combined=[];
  activeCategories.forEach(cat=>{ if(patrolSchedules[cat]) combined=combined.concat(patrolSchedules[cat]); });
  return combined;
}

function showUpcomingPatrols(){
  const now=new Date(), nowM=now.getHours()*60+now.getMinutes();
  const list=document.getElementById("upcomingList");
  list.innerHTML="";
  const upcoming=[];
  const patrolSchedule=getActivePatrolSchedule();
  patrolSchedule.forEach(task=>{
    if(!(new Date(now.toISOString().slice(0,10))>=new Date(task.startDate) && new Date(now.toISOString().slice(0,10))<=new Date(task.endDate))) return;
    if(!task.daysOfWeek.includes(now.getDay())) return;
    task.timeRanges.forEach(r=>{
      const [sH,sM]=r.start.split(":").map(Number);
      const [eH,eM]=r.end.split(":").map(Number);
      const startM=sH*60+sM-30, endM=eH*60+eM+30;
      const isOngoing=nowM>=sH*60+sM && nowM<=eH*60+eM;
      const isInWindow=nowM>=startM && nowM<=endM;
      const patrolKey=`${task.id}|${r.start}~${r.end}`;
      if(isInWindow && !completedPatrols.has(patrolKey)) upcoming.push({task,hour:sH,minute:sM,endHour:eH,endMinute:eM,key:patrolKey,isInTime:isOngoing});
    });
  });
  if(upcoming.length===0){ list.innerHTML="<li>✅ 예정 없음</li>"; return; }
  upcoming.sort((a,b)=>(a.hour*60+a.minute)-(b.hour*60+b.minute));
  upcoming.forEach(item => {
  const li = document.createElement("li");
  li.style.color = item.isInTime ? "blue" : "black";
  li.textContent = `${item.task.id} - ${pad(item.hour)}:${pad(item.minute)}~${pad(item.endHour)}:${pad(item.endMinute)}`;

  li.onclick = () => {
    activePatrol = { task: item.task, hour: item.hour, minute: item.minute, key: item.key };
    
    // 선택한 순찰 대상의 좌표 가져오기
    const patrolId = item.task.id;
    const data = lampData[patrolId];
    if (!data || !data.좌표) { alert("⚠️ 좌표 정보 없음"); return; }
    lastClickedCoord = data.좌표;
    document.getElementById("clickedCoords").innerText = `📍 선택: ${lastClickedCoord}`;

    // 바로 길찾기 실행
    navigateToPatrol();
  };

  list.appendChild(li);
 });
}

document.querySelectorAll("#categoryList li").forEach(li=>{
  li.addEventListener("click", ()=>{
    const cat=li.getAttribute("data-cat");
    if(activeCategories.includes(cat)){
      activeCategories=activeCategories.filter(c=>c!==cat);
      li.style.background="white"; li.style.color="#007bff"; li.style.border="1px solid #007bff";
    } else {
      activeCategories.push(cat);
      li.style.background="#007bff"; li.style.color="white"; li.style.border="1px solid #007bff";
    }
    showUpcomingPatrols();
  });
});

document.getElementById("upcomingPanel").addEventListener("click",e=>{
  if(e.target.tagName.toLowerCase()!=="li") e.currentTarget.classList.toggle("hidden");
});

showUpcomingPatrols();
</script>

</body>
</html>


